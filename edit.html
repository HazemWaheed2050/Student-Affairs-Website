<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit Student</title>
    <link rel="shortcut icon" href="assets/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="assets/style.css">
    <script src="assets/script.js"></script>
</head>
<body>
<nav class="navbar">
    <a href="home.html" class="navbar-logo"></a>
    <a href="home.html">Home</a>
    <a href="add.html">Add Student</a>
    <a href="active.html">Active Students</a>
    <a href="search.html">Search Students</a>
</nav>

<div class="container">
    <div class="hide" id="message-modal-container">
        <span id="message-modal-text">
            Success!
        </span>
    </div>
    <form method="post" name="add-student" id="edit-student-form" class="student-form">
        <h3>Edit student</h3>
        <div class="double-field-container">
            <div>
                <label for="name-field">Name</label>
                <input id="name-field" type="text" name="name" required>
            </div>
            <div>
                <label for="id-field">ID</label>
                <input type="text" id="id-field" name="id" required disabled>
            </div>
        </div>
        <div class="double-field-container">
            <div>
                <label for="email-field">Email</label>
                <input type="email" id="email-field" name="email" placeholder="example@ex.com">
            </div>
            <div>
                <label for="phone-field">Phone number</label>
                <input type="text" id="phone-field" name="phone" placeholder="xxxxxxxxxxx">
            </div>
        </div>
        <div class="field-container">
            <div>
                <label for="dob-field">Birth date</label>
                <input type="date" id="dob-field" name="dob" required>
            </div>
        </div>
        <div class="double-field-container">
            <div>
                <label for="student-gender-dropdown">Gender</label>
                <select name="status" id="student-gender-dropdown">
                    <option value="male"> Male
                    <option value="female"> Female
                </select>
            </div>

            <div>
                <label for="student-status-dropdown">Status</label>
                <select name="status" id="student-status-dropdown">
                    <option value="1"> Active
                    <option value="2"> Inactive
                </select>
            </div>
        </div>

        <div class="field-container">
            <div>
                <label for="gpa-field">GPA</label>
                <input type="number" id="gpa-field" min="0" max="4.0" step="0.01" value="0.0" name="gpa" required>
            </div>
        </div>

        <div class="double-field-container">
            <div>
                <label for="level-dropdown">Level</label>
                <select name="level" id="level-dropdown">
                    <option value="1"> 1
                    <option value="2"> 2
                    <option value="3"> 3
                    <option value="4"> 4
                </select>
            </div>

            <div>
                <!-- This field should only be shown when level > 2 -->
                <label for="department-dropdown">Department</label>
                <select name="department" id="department-dropdown">
                    <option value="it"> IT
                    <option value="ai"> AI
                    <option value="cs"> CS
                    <option value="is"> IS
                    <option value="ds"> DS
                </select>
            </div>
        </div>

        <div class="buttons">
            <input type="submit" value="Save" class="button">
        </div>
    </form>
</div>


<script>
    const form = document.querySelector("#edit-student-form");

    const queryString = window.location.search;
    const searchParams = new URLSearchParams(queryString);

    const stud = JSON.parse(localStorage.getItem(searchParams.get('id')));
    for (const [key, value] of Object.entries(stud)) {
        form.elements[key].value = value;
    }

    const lvl_menu = document.querySelector("#level-dropdown");
    const dep_menu = document.querySelector("#department-dropdown");
    lvl_menu.addEventListener("change", (event) => {
        dep_menu.disabled = lvl_menu.selectedIndex < 2;
    });

    form.addEventListener("submit", (event) => {
        event.preventDefault();

        const formData = new FormData(event.target);

        const obj = stud;

        for (const [key, value] of formData.entries()) {
            obj[key] = value;
        }

        if (obj['level'] <= 2) {
            obj['department'] = 'general';
        }

        const cont = document.querySelector("#message-modal-container");

        // validation
        if (!validateID(obj['id'])) {
            console.log(obj['id']);
            cont.classList.remove("hide");
            cont.classList.remove("success-msg");
            cont.classList.add("error-msg");
            cont.querySelector("#message-modal-text").innerHTML = "Error:\n\t Invalid Student ID.";
        } else if (!validateEmail(obj['email'])) {
            cont.classList.remove("hide");
            cont.classList.remove("success-msg");
            cont.classList.add("error-msg");
            cont.querySelector("#message-modal-text").innerHTML = "Error:\n\t Invalid Email Address.";
        } else if (!validatePhoneNumber(obj['phone'])) {
            cont.classList.remove("hide");
            cont.classList.remove("success-msg");
            cont.classList.add("error-msg");
            cont.querySelector("#message-modal-text").innerHTML = "Error:\n\t Invalid Phone number.";
        } else {
            localStorage.setItem(obj['id'], JSON.stringify(obj));

            cont.classList.remove("hide");
            cont.classList.remove("error-msg");
            cont.classList.add("success-msg");
            cont.querySelector("#message-modal-text").innerHTML = "Edits Saved";
        }

    });
</script>

</body>
</html>